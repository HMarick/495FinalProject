---
title: "K-NN"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(class)
library(MLmetrics)
library(tidyr)
library(dplyr)
library(grid)
library(jpeg)
library(rjson)
library(RCurl)
library(densityvis)
```


```{r}
shots<-read.csv("data.csv") #read in data
shots2<-shots %>% 
  mutate(shot_made_flag=as.numeric(shot_made_flag), 
         action_type=as.numeric(action_type), combined_shot_type=as.numeric(combined_shot_type),
         playoffs=as.numeric(playoffs), shot_type=as.numeric(shot_type),
         shot_zone_area=as.numeric(shot_zone_area), shot_zone_basic=as.numeric(shot_zone_basic),
         shot_zone_range=as.numeric(shot_zone_range), period=as.numeric(period))
test<-subset(shots2, is.na(shot_made_flag))
train<-subset(shots2, !is.na(shot_made_flag))

```



```{r}
courtImg.URL <- "https://thedatagame.files.wordpress.com/2016/03/nba_court.jpg"
court <- rasterGrob(readJPEG(getURLContent(courtImg.URL)),
           width=unit(1,"npc"), height=unit(1,"npc"))


train2<-subset(train2, center_y<350 & abs(center_x)<250)
closest<-hex_pos(train2$loc_x, train2$loc_y, 70,70)
train2$center_x=closest[,1]
train2$center_y=closest[,2]

train3<-train2 %>%
  group_by(center_x, center_y) %>%
  summarise(makes=sum(shot_made_flag), tot=n()) %>%
  mutate(Accuracy=100*makes/tot) 


ggplot(train3, aes(center_x,center_y, color=Accuracy)) +
  annotation_custom(court, -250, 250, -52, 418) +
  geom_point(aes(size=tot)) + 
  scale_color_gradient(low="blue", high="red") + 
  guides(alpha = FALSE, size = FALSE) +
  xlim(250, -250) +
  ylim(-52, 418) +
  xlab("") + ylab("") + ggtitle("Kobe Bryant Shot Accuracy")
```




```{r}
k_vals=c(1,3,5,7,9,11,13,15)
y=train$shot_made_flag
x=train[,c(-15, -3, -4, -12, -20, -21, -22, -23, -24, -25)]
idx<-createFolds(y, k=10)
errors_for_k=rep(0, length(k_vals))
for (j in 1:length(k_vals)){
  errors<-rep(0, 10)
for (i in 1:10) {
  psuedo_train=x[ -idx[[i]] , ]
  psuedo_test=x[ idx[[i]], ]
  outcomes<-y[ -idx[[i]] ]
  pred <- class::knn(train=psuedo_train, test=psuedo_test, cl=outcomes, k=5)
  errors[i]=round(mean(y[ idx[[i]] ] != pred),3)
}
  errors_for_k[j]=mean(errors)
}
```


